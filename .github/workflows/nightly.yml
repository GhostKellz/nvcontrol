name: Nightly Sanity Sweep

on:
  schedule:
    - cron: '30 7 * * *'  # 7:30 AM UTC daily
  workflow_dispatch:

jobs:
  nightly:
    name: "Nightly validation"
    runs-on: self-hosted
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Verify Environment
        run: |
          export PATH="/home/runner/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/bin:$PATH"
          set -euo pipefail
          echo "=== Nightly Build $(date -u +%Y-%m-%d) ==="
          rustc --version
          cargo --version
          nvidia-smi --query-gpu=name,driver_version --format=csv,noheader

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: nvcontrol-nightly

      - name: Full build
        run: |
          export PATH="/home/runner/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/bin:$PATH"
          cargo build --release --no-default-features

      - name: Full test sweep
        run: |
          export PATH="/home/runner/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/bin:$PATH"
          cargo test --lib --no-default-features

      - name: Clippy strict
        run: |
          export PATH="/home/runner/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/bin:$PATH"
          cargo clippy --bin nvctl --lib --no-default-features -- \
            -W clippy::all \
            -W clippy::pedantic \
            -A clippy::needless-borrows-for-generic-args \
            -A clippy::single-char-add-str \
            -A clippy::redundant-field-names \
            -A clippy::module-name-repetitions \
            -A clippy::too-many-lines \
            -A clippy::missing-errors-doc \
            -A clippy::missing-panics-doc

      - name: Format check
        run: |
          export PATH="/home/runner/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/bin:$PATH"
          cargo fmt --check

      - name: GPU stress test
        run: |
          set -euo pipefail
          NVCTL=$(find target -path "*/release/nvctl" -type f -executable | head -1)

          echo "=== Extended CLI Tests ==="
          $NVCTL --version
          $NVCTL gpu info
          $NVCTL fan info
          $NVCTL power status
          $NVCTL config show
          $NVCTL doctor

          echo ""
          echo "=== Repeated queries (stability check) ==="
          for i in 1 2 3 4 5; do
            $NVCTL gpu info > /dev/null
            echo "Query $i: OK"
          done

          echo ""
          echo "✅ GPU stress test passed"

      - name: Binary size check
        run: |
          set -euo pipefail
          NVCTL=$(find target -path "*/release/nvctl" -type f -executable | head -1)
          SIZE=$(stat -c%s "$NVCTL" 2>/dev/null || stat -f%z "$NVCTL")
          SIZE_MB=$((SIZE / 1024 / 1024))
          echo "Binary size: ${SIZE_MB}MB ($SIZE bytes)"
          if [ "$SIZE_MB" -gt 50 ]; then
            echo "::warning::Binary size exceeds 50MB"
          fi

      - name: Nightly Summary
        run: |
          export PATH="/home/runner/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/bin:$PATH"
          echo "### Nightly Build $(date -u +%Y-%m-%d) ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Clippy | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| GPU Tests | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Binary | $(find target -path '*/release/nvctl' -type f -executable -exec ls -lh {} \; | awk '{print $5}' | head -1) |" >> $GITHUB_STEP_SUMMARY
