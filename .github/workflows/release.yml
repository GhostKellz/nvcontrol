name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: self-hosted
    name: Build Release (nv-osmium)
    timeout-minutes: 20
    env:
      PATH: /home/runner/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Verify Environment
        run: |
          set -euo pipefail
          echo "=== Release Build ==="
          echo "Tag: ${{ github.ref_name }}"
          rustc --version
          cargo --version
          nvidia-smi --query-gpu=name --format=csv,noheader

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: nvcontrol-release

      - name: Build Release (CLI only)
        run: cargo build --bin nvctl --release --no-default-features

      - name: Run Tests
        run: |
          cargo test --lib --no-default-features
          NVCTL=$(find target -path "*/release/nvctl" -type f -executable | head -1)
          $NVCTL --version
          $NVCTL gpu info

      - name: Create Release Archive
        run: |
          set -euo pipefail
          VERSION="${{ github.ref_name }}"
          ARCHIVE_DIR="nvcontrol-${VERSION}"
          NVCTL=$(find target -path "*/release/nvctl" -type f -executable | head -1)

          mkdir -p "$ARCHIVE_DIR"
          cp "$NVCTL" "$ARCHIVE_DIR/nvctl"
          cp README.md LICENSE "$ARCHIVE_DIR/" 2>/dev/null || true
          [ -f DOCS.md ] && cp DOCS.md "$ARCHIVE_DIR/"
          [ -f COMMANDS.md ] && cp COMMANDS.md "$ARCHIVE_DIR/"

          tar -czf "nvcontrol-${VERSION}-linux-x86_64.tar.gz" "$ARCHIVE_DIR"

          echo "=== Archive Contents ==="
          tar -tvf "nvcontrol-${VERSION}-linux-x86_64.tar.gz"
          ls -lh "nvcontrol-${VERSION}-linux-x86_64.tar.gz"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: nvcontrol-${{ github.ref_name }}-linux-x86_64.tar.gz
          draft: false
          prerelease: ${{ contains(github.ref_name, 'rc') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "### Release ${{ github.ref_name }} âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Binary | nvctl $(find target -path '*/release/nvctl' -type f -executable -exec ls -lh {} \; | awk '{print $5}' | head -1)" >> $GITHUB_STEP_SUMMARY
          echo "| Archive | $(ls -lh nvcontrol-${{ github.ref_name }}-linux-x86_64.tar.gz | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
          echo "| GPU Tested | $(nvidia-smi --query-gpu=name --format=csv,noheader)" >> $GITHUB_STEP_SUMMARY
