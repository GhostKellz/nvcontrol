name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: self-hosted
    name: Build & Test (nv-osmium)
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Verify Environment
        run: |
          export PATH="/home/runner/.cargo/bin:$PATH"
          set -euo pipefail
          echo "=== Rust Toolchain ==="
          rustc --version
          cargo --version
          echo ""
          echo "=== NVIDIA GPU ==="
          nvidia-smi --query-gpu=name,driver_version,memory.total --format=csv,noheader

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: nvcontrol-ci

      - name: Build CLI
        run: |
          export PATH="/home/runner/.cargo/bin:$PATH"
          cargo build --bin nvctl --release --no-default-features

      - name: Clippy
        run: |
          export PATH="/home/runner/.cargo/bin:$PATH"
          cargo clippy --bin nvctl --lib --no-default-features -- \
            -W clippy::all \
            -A clippy::needless-borrows-for-generic-args \
            -A clippy::single-char-add-str \
            -A clippy::redundant-field-names

      - name: Format Check
        run: |
          export PATH="/home/runner/.cargo/bin:$PATH"
          cargo fmt --check || echo "::warning::Format issues found"

      - name: Unit Tests
        run: |
          export PATH="/home/runner/.cargo/bin:$PATH"
          cargo test --lib --no-default-features

      - name: GPU Smoke Test
        run: |
          set -euo pipefail
          NVCTL=$(find target -path "*/release/nvctl" -type f -executable | head -1)

          echo "=== Basic Commands ==="
          $NVCTL --version
          $NVCTL --help > /dev/null

          echo ""
          echo "=== GPU Info ==="
          $NVCTL gpu info

          echo ""
          echo "=== System Doctor ==="
          $NVCTL doctor || true

          echo ""
          echo "✅ GPU smoke tests passed"

      - name: CLI Test Suite
        run: |
          set -euo pipefail
          NVCTL=$(find target -path "*/release/nvctl" -type f -executable | head -1)
          PASSED=0
          FAILED=0

          test_cmd() {
            local name="$1"
            local cmd="$2"
            local output
            if output=$($NVCTL $cmd 2>&1); then
              echo "✅ $name"
              PASSED=$((PASSED + 1))
            else
              echo "❌ $name"
              echo "   Error: $output"
              FAILED=$((FAILED + 1))
            fi
          }

          echo "=== CLI Commands ==="
          test_cmd "version" "--version"
          test_cmd "help" "--help"
          test_cmd "gpu info" "gpu info"
          test_cmd "fan info" "fan info"
          test_cmd "power status" "power status"
          test_cmd "config show" "config show"
          test_cmd "doctor" "doctor"

          echo ""
          echo "Results: $PASSED passed, $FAILED failed"

          if [[ $FAILED -gt 0 ]]; then
            exit 1
          fi

      - name: Build Summary
        run: |
          export PATH="/home/runner/.cargo/bin:$PATH"
          echo "### Build Complete ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Binary | $(find target -path '*/release/nvctl' -type f -executable -exec ls -lh {} \; | awk '{print $5}' | head -1)" >> $GITHUB_STEP_SUMMARY
          echo "| Rust | $(rustc --version | cut -d' ' -f2)" >> $GITHUB_STEP_SUMMARY
          echo "| GPU | $(nvidia-smi --query-gpu=name --format=csv,noheader)" >> $GITHUB_STEP_SUMMARY
